[{"id":"llamaindex_text_to_sql_rag","user_id":"7b1679ba-3a8e-4da0-8abf-71bf8a5ac5b4","name":"LlamaIndex Text to SQL RAG","type":"pipe","content":"\"\"\"\ntitle: Llama Index DB Pipe\nauthor: James W. (0xThresh)\nauthor_url: https://github.com/0xThresh\nfunding_url: https://github.com/open-webui\nversion: 1.3\nrequirements: llama_index, sqlalchemy, mysql-connector, psycopg2-binary, llama_index.llms.ollama\n\"\"\"\n\nfrom pydantic import BaseModel, Field\nfrom typing import Union, Generator, Iterator, Optional\nimport os\nfrom llama_index.llms.ollama import Ollama\nfrom llama_index.core.query_engine import NLSQLTableQueryEngine\nfrom llama_index.core import SQLDatabase, PromptTemplate\nimport llama_index.core\nfrom sqlalchemy import create_engine\nfrom open_webui.utils.misc import get_last_user_message\nimport logging\n\n\nclass Pipe:\n    class Valves(BaseModel):\n        DB_ENGINE: str = Field(\n            os.getenv(\"DB_TYPE\", \"postgres\"),\n            description=\"Database type (supports 'postgres' and 'mysql', defaults to postgres)\",\n        )\n        DB_HOST: str = Field(\n            os.getenv(\"DB_HOST\", \"host.docker.internal\"),\n            description=\"Database hostname\",\n        )\n        DB_PORT: str = Field(\n            os.getenv(\"DB_PORT\", \"5432\"), description=\"Database port (default: 5432)\"\n        )\n        DB_USER: str = Field(\n            os.getenv(\"DB_USER\", \"postgres\"),\n            description=\"Database user to connect with. Make sure this user has permissions to the database and tables you define\",\n        )\n        DB_PASSWORD: str = Field(\n            os.getenv(\"DB_PASSWORD\", \"password\"), description=\"Database user's password\"\n        )\n        DB_DATABASE: str = Field(\n            os.getenv(\"DB_DATABASE\", \"postgres\"),\n            description=\"Database with the data you want to ask questions about\",\n        )\n        DB_TABLE: str = Field(\n            os.getenv(\"DB_TABLE\", \"table\"),\n            description=\"Table in the database with the data you want to ask questions about\",\n        )\n        OLLAMA_HOST: str = Field(\n            os.getenv(\"OLLAMA_HOST\", \"http://host.docker.internal:11434\"),\n            description=\"Hostname of the Ollama host with the model\",\n        )\n        TEXT_TO_SQL_MODEL: str = Field(\n            os.getenv(\"TEXT_TO_SQL_MODEL\", \"llama3.2:3b\"),\n            description=\"LLM model to use for text-to-SQL operation. You may need to experiment with different models for best results\",\n        )\n        CONTEXT_WINDOW: int = Field(\n            os.getenv(\"CONTEXT_WINDOW\", 30000),\n            description=\"The number of tokens to use in the context window\",\n        )\n        pass\n\n    def __init__(self):\n        self.valves = self.Valves()\n        self.log = logging.getLogger(__name__)\n        # Update or comment out log level as needed\n        self.log.setLevel(logging.DEBUG)\n        self.type = \"pipe\"\n        self.name = \"Database RAG Pipeline\"\n        self.engine = None\n        self.nlsql_response = \"\"\n        pass\n\n    def init_db_connection(self):\n        # Update your DB connection string based on selected DB engine - current connection string is for Postgres\n        if self.valves.DB_ENGINE == \"mysql\":\n            self.engine = create_engine(\n                f\"mysql+mysqlconnector://{self.valves.DB_USER}:{self.valves.DB_PASSWORD}@{self.valves.DB_HOST}:{self.valves.DB_PORT}/{self.valves.DB_DATABASE}\"\n            )\n        elif self.valves.DB_ENGINE == \"postgres\":\n            self.engine = create_engine(\n                f\"postgresql+psycopg2://{self.valves.DB_USER}:{self.valves.DB_PASSWORD}@{self.valves.DB_HOST}:{self.valves.DB_PORT}/{self.valves.DB_DATABASE}\"\n            )\n        else:\n            raise ValueError(f\"Unsupported database engine: {self.valves.DB_ENGINE}\")\n\n        return self.engine\n\n    async def pipe(\n        self,\n        body: dict,\n        __user__: dict,\n        __event_emitter__=None,\n        __event_call__=None,\n        __task__=None,\n        __task_body__: Optional[dict] = None,\n        __valves__=None,\n    ) -> Union[str, Generator, Iterator]:\n        await __event_emitter__(\n            {\n                \"type\": \"status\",\n                \"data\": {\"description\": \"Connecting to the database...\", \"done\": False},\n            }\n        )\n\n        print(f\"pipe:{__name__}\")\n\n        print(__event_emitter__)\n        print(__event_call__)\n\n        # Create database reader for Postgres\n        self.init_db_connection()\n        sql_database = SQLDatabase(\n            self.engine, include_tables=self.valves.DB_TABLE.split(\",\")\n        )\n        await __event_emitter__(\n            {\n                \"type\": \"status\",  # We set the type here\n                \"data\": {\"description\": \"Querying the database...\", \"done\": False},\n            }\n        )\n\n        # Set up LLM connection\n        llm = Ollama(\n            model=self.valves.TEXT_TO_SQL_MODEL,\n            base_url=self.valves.OLLAMA_HOST,\n            request_timeout=300.0,\n            context_window=self.valves.CONTEXT_WINDOW,\n        )\n\n        # Set up the custom prompt used when generating SQL queries from text\n        text_to_sql_prompt = \"\"\"\n        Given an input question, first create a syntactically correct {dialect} query to run, then look at the results of the query and return the answer. \n        You can order the results by a relevant column to return the most interesting examples in the database.\n        Unless the user specifies in the question a specific number of examples to obtain, query for at most 5 results using the LIMIT clause as per the database engine. You can order the results to return the most informative data in the database.\n        Never query for all the columns from a specific table, only ask for a few relevant columns given the question.\n        You should use DISTINCT statements and avoid returning duplicates wherever possible.\n        Do not return example data if no data is found. You have access to a SQL database, and the only results you should return are values from that database.\n        Pay attention to use only the column names that you can see in the schema description. Be careful to not query for columns that do not exist. Pay attention to which column is in which table. Also, qualify column names with the table name when needed. You are required to use the following format, each taking one line:\n\n        Question: Question here\n        SQLQuery: SQL Query to run\n        SQLResult: Result of the SQLQuery\n        Answer: Final answer here\n\n        Only use tables listed below.\n        {schema}\n\n        Question: {query_str}\n        SQLQuery: \n        \"\"\"\n\n        text_to_sql_template = PromptTemplate(text_to_sql_prompt)\n\n        query_engine = NLSQLTableQueryEngine(\n            sql_database=sql_database,\n            tables=self.valves.DB_TABLE.split(\",\"),\n            llm=llm,\n            text_to_sql_prompt=text_to_sql_template,\n            embed_model=\"local\",\n            streaming=True,\n        )\n\n        user_message = get_last_user_message(body[\"messages\"])\n\n        await __event_emitter__(\n            {\n                \"type\": \"status\",\n                \"data\": {\"description\": \"Returning response...\", \"done\": True},\n            }\n        )\n\n        response = query_engine.query(user_message)\n\n        return response.response_gen\n","meta":{"description":"Uses LlamaIndex NLSQL Query Engines to let you ask questions about the data in your database","manifest":{"title":"Llama Index DB Pipe","author":"James W. (0xThresh)","author_url":"https://github.com/0xThresh","funding_url":"https://github.com/open-webui","version":"1.3","requirements":"llama_index, sqlalchemy, mysql-connector, psycopg2-binary, llama_index.llms.ollama"},"type":"pipe","user":{"id":"67b76a7e-ce34-4e54-a3b4-f8777b4fea1d","username":"0xthresh","name":"tmp","createdAt":1716766748,"role":"tmp","verified":false},"id":"516b41c4-23b5-4fea-aa66-c853e637aae8"},"is_active":true,"is_global":false,"updated_at":1761778117,"created_at":1761764587}]